name: Build & Release

on:
  push:
    branches:
      - main

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_prerelease: ${{ steps.get_version.outputs.is_prerelease }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆ changelog

      - name: æå–ç‰ˆæœ¬å·
        id: get_version
        run: |
          # ä» README.md æå–ç‰ˆæœ¬å·ï¼ˆæ”¯æŒä»»æ„åç¼€ï¼ŒåŒ…æ‹¬ Shields.io çš„ -- è½¬ä¹‰ï¼‰
          # åŒ¹é…æ ¼å¼: version-X.Y.Z-é¢œè‰² æˆ– version-X.Y.Z--åç¼€-é¢œè‰²
          # æ³¨æ„ï¼šShields.io ä¸­ - éœ€è¦ç”¨ -- è½¬ä¹‰ï¼Œæ‰€ä»¥ 2.0.3-beta åœ¨ badge ä¸­æ˜¯ 2.0.3--beta
          full_version=$(sed -n 's/.*badge\/version-\([0-9]\+\.[0-9]\+\.[0-9]\+\(--\?[a-zA-Z0-9]\+\)\?\)-.*/\1/p' README.md | head -n1)

          if [ -z "$full_version" ]; then
            echo "âŒ æ— æ³•æå–ç‰ˆæœ¬å·ï¼Œè¯·æ£€æŸ¥ README.md ä¸­çš„ç‰ˆæœ¬æ ¼å¼"
            echo "æœŸæœ›æ ¼å¼: badge/version-X.Y.Z-é¢œè‰² æˆ– badge/version-X.Y.Z--åç¼€-é¢œè‰²"
            exit 1
          fi

          echo "ğŸ“¦ åŸå§‹ç‰ˆæœ¬: $full_version"

          # å°† Shields.io çš„ -- è½¬ä¹‰è¿˜åŸä¸º -
          full_version=$(echo "$full_version" | sed 's/--/-/g')
          echo "ğŸ”„ è¿˜åŸè½¬ä¹‰: $full_version"

          # ç§»é™¤ -stable åç¼€ï¼ˆæ­£å¼ç‰ˆä¸éœ€è¦ stable æ ‡è¯†ï¼‰
          clean_version=$(echo "$full_version" | sed 's/-stable$//')

          echo "âœ… æ¸…ç†åç‰ˆæœ¬: $clean_version"
          echo "version=$clean_version" >> $GITHUB_OUTPUT

          # åˆ¤æ–­æ˜¯å¦ä¸ºæ­£å¼ç‰ˆæœ¬
          # æ­£å¼ç‰ˆï¼šçº¯æ•°å­— (X.Y.Z) æˆ– X.Y.Z-stableï¼ˆå·²å»é™¤ -stableï¼‰
          if [[ "$clean_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "âœ¨ æ­£å¼ç‰ˆæœ¬"
          else
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "ğŸ§ª é¢„å‘å¸ƒç‰ˆæœ¬ (${clean_version##*-})"
          fi

  build-windows:
    needs: get-version
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: åˆå§‹åŒ– conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          miniforge-version: latest
          activate-environment: Smile2Unlock
          python-version: '3.11.9'

      - name: åˆ›å»º conda ç¯å¢ƒ
        shell: bash
        run: conda create -n Smile2Unlock python=3.11.9 -y

      - name: é€šè¿‡ conda å®‰è£… dlib
        shell: bash
        run: conda install dlib=19.24.4 -c conda-forge -y

      - name: é€šè¿‡ pip å®‰è£…å…¶ä»–å¿…è¦åº“
        shell: bash
        run: |
          conda run -n Smile2Unlock pip install cmake==3.29.3 face_recognition opencv-contrib-python==4.9.0.80 pynput screeninfo numpy==1.26.4 torch==2.2.2 torchvision==0.17.2 torchaudio==2.2.2

      - name: å®‰è£…PyInstaller
        shell: bash
        run: conda run -n Smile2Unlock pip install pyinstaller

      - name: æ‰“åŒ…ä¸ºWindowså¯æ‰§è¡Œæ–‡ä»¶
        shell: bash
        run: conda run -n Smile2Unlock pyinstaller --clean --noconfirm .\\smile2unlock.spec

      - name: ä¸Šä¼  Windows æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Smile2Unlock-win
          path: dist\Smile2Unlock\*.exe

#  build-linux:
#    needs: get-version
#    runs-on: ubuntu-latest
#    steps:
#      - name: æ£€å‡ºä»£ç 
#        uses: actions/checkout@v4
#
#      - name: è®¾ç½®Pythonç¯å¢ƒ
#        uses: actions/setup-python@v5
#        with:
#          python-version: '3.11'
#
#      - name: å®‰è£…ä¾èµ–
#        run: |
#          if [ -f pip_requirements.txt ]; then
#            pip install -r pip_requirements.txt || pip install cmake==3.29.3 face-recognition opencv-contrib-python==4.9.0.80 pynput screeninfo numpy==1.26.4 torch==2.2.2 torchvision==0.17.2 torchaudio==2.2.2
#          elif [ -f requirements.txt ]; then
#            pip install -r requirements.txt
#          else
#            pip install cmake==3.29.3 face-recognition opencv-contrib-python==4.9.0.80 pynput screeninfo numpy==1.26.4 torch==2.2.2 torchvision==0.17.2 torchaudio==2.2.2
#          fi
#
#      - name: å®‰è£…PyInstaller
#        run: pip install pyinstaller
#
#      - name: æ‰“åŒ…ä¸ºLinuxå¯æ‰§è¡Œæ–‡ä»¶
#        run: |
#          pyinstaller --clean --noconfirm ./smile2unlock.spec
#          # ç¡®ä¿å¯æ‰§è¡Œæƒé™
#          chmod +x dist/Smile2Unlock/* || true
#
#      - name: ä¸Šä¼  Linux æ„å»ºäº§ç‰©
#        uses: actions/upload-artifact@v4
#        with:
#          name: Smile2Unlock-linux
#          path: dist/Smile2Unlock/*

  create-release:
    needs: [build-windows, get-version]
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆ changelog

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: ç”Ÿæˆ Changelog
        id: changelog
        run: |
          VERSION=${{ needs.get-version.outputs.version }}
          TAG="v$VERSION"
          BASE_VERSION=$(echo "$VERSION" | sed 's/-.*$//')

          echo "ğŸ“¦ å®Œæ•´ç‰ˆæœ¬: $VERSION"
          echo "ğŸ“¦ åŸºç¡€ç‰ˆæœ¬: $BASE_VERSION"

          # 1. å…ˆä¿å­˜å½“å‰ tag çš„æ—§å†…å®¹ï¼ˆåˆ é™¤å‰ï¼‰
          echo "ğŸ” æ£€æŸ¥ $TAG æ˜¯å¦å·²å­˜åœ¨..."
          OLD_BODY=$(gh release view $TAG --json body -q .body 2>/dev/null || echo "")

          # 2. å°è¯•ä»åŒç‰ˆæœ¬çš„å…¶ä»– Release è·å–å¤´éƒ¨å’Œå˜æ›´ï¼ˆå¦‚ v2.0.3-beta è·å– v2.0.3 çš„å†…å®¹ï¼‰
          INHERITED_HEADER=""
          INHERITED_CHANGES=""
          if [ -z "$OLD_BODY" ]; then
            echo "ğŸ” æŸ¥æ‰¾åŒç‰ˆæœ¬ (v$BASE_VERSION*) çš„å…¶ä»– Release..."
            # è·å–åŒç‰ˆæœ¬çš„æ‰€æœ‰ Release
            SAME_VERSION_RELEASES=$(gh release list --limit 50 | grep "^v$BASE_VERSION" | head -n 1 | awk '{print $1}')

            if [ -n "$SAME_VERSION_RELEASES" ] && [ "$SAME_VERSION_RELEASES" != "$TAG" ]; then
              echo "ğŸ“ å‘ç°åŒç‰ˆæœ¬ Release: $SAME_VERSION_RELEASES"
              RELATED_BODY=$(gh release view "$SAME_VERSION_RELEASES" --json body -q .body 2>/dev/null || echo "")
              if [ -n "$RELATED_BODY" ]; then
                # æå–å¤´éƒ¨å†…å®¹ï¼ˆWhat's Changed ä¹‹å‰ï¼‰
                INHERITED_HEADER=$(echo "$RELATED_BODY" | sed -n '1,/## What'\''s Changed/p' | sed '$d')
                # æå– What's Changed ä¸­çš„æ¡ç›®ï¼ˆåªå– "- " å¼€å¤´ï¼Œé¿å…åˆ†éš”çº¿é‡å¤ï¼‰
                INHERITED_CHANGES=$(echo "$RELATED_BODY" | awk '/^## What\x27s Changed/{flag=1;next}/^## /{flag=0}flag && /^- /{print}')
              fi
            fi
          fi

          # 3. ç”Ÿæˆæ–°çš„æäº¤è®°å½•
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "ğŸ“ é¦–æ¬¡å‘å¸ƒï¼Œç”Ÿæˆå®Œæ•´å†å²"
            NEW_COMMITS=$(git log --pretty=format:"- %s by @%an (%ad)" --date=format:'%b %d, %I:%M %p GMT%z' --no-merges | sed 's/GMT+/GMT+/;s/GMT-/GMT-/')
          else
            echo "ğŸ“ ç”Ÿæˆä» $PREV_TAG åˆ°å½“å‰çš„æ›´æ–°æ—¥å¿—"
            NEW_COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s by @%an (%ad)" --date=format:'%b %d, %I:%M %p GMT%z' --no-merges | sed 's/GMT+/GMT+/;s/GMT-/GMT-/')
          fi

          # 4. æ„å»ºæœ€ç»ˆçš„ Changelog
          > changelog.md  # æ¸…ç©ºæ–‡ä»¶

          if [ -n "$OLD_BODY" ]; then
            echo "ğŸ“‹ ä¿ç•™å½“å‰ tag çš„æ—§å†…å®¹"
            # æå–å¤´éƒ¨
            HEADER=$(echo "$OLD_BODY" | sed -n '1,/## What'\''s Changed/p' | sed '$d')
            # æå–æ—§çš„å˜æ›´è®°å½•ï¼ˆåªè¦ä»¥ "- " å¼€å¤´ï¼Œé¿å…åˆ†éš”çº¿é‡å¤ï¼‰
            OLD_CHANGES=$(echo "$OLD_BODY" | awk '/^## What\x27s Changed/{flag=1;next}/^## /{flag=0}flag && /^- /{print}')

            if [ -n "$HEADER" ]; then
              echo "$HEADER" >> changelog.md
              echo "" >> changelog.md
            fi

            echo "## What's Changed" >> changelog.md
            echo "--------------" >> changelog.md
            echo "$NEW_COMMITS" >> changelog.md

            if [ -n "$OLD_CHANGES" ]; then
              echo "$OLD_CHANGES" >> changelog.md
            fi
          elif [ -n "$INHERITED_HEADER" ]; then
            echo "ğŸ“ ç»§æ‰¿åŒç‰ˆæœ¬ Release çš„å®Œæ•´å†…å®¹"
            echo "$INHERITED_HEADER" >> changelog.md
            echo "" >> changelog.md
            echo "## What's Changed" >> changelog.md
            echo "--------------" >> changelog.md
            echo "$NEW_COMMITS" >> changelog.md

            if [ -n "$INHERITED_CHANGES" ]; then
              echo "ğŸ“‹ è¿½åŠ ç»§æ‰¿çš„æ—§å˜æ›´è®°å½•"
              echo "$INHERITED_CHANGES" >> changelog.md
            fi
          else
            echo "âœ¨ åˆ›å»ºå…¨æ–° Release"
            echo "## What's Changed" >> changelog.md
            echo "--------------" >> changelog.md
            echo "$NEW_COMMITS" >> changelog.md
          fi

          echo "âœ… Changelog ç”Ÿæˆå®Œæˆ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥å¹¶åˆ é™¤å·²å­˜åœ¨çš„ Release å’Œæ ‡ç­¾
        run: |
          VERSION=${{ needs.get-version.outputs.version }}
          TAG="v$VERSION"

          echo "ğŸ” æ£€æŸ¥æ ‡ç­¾ $TAG æ˜¯å¦å­˜åœ¨"

          # æ£€æŸ¥è¿œç¨‹æ ‡ç­¾æ˜¯å¦å­˜åœ¨
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "âš ï¸  æ ‡ç­¾ $TAG å·²å­˜åœ¨ï¼Œå‡†å¤‡åˆ é™¤"

            # åˆ é™¤è¿œç¨‹ Releaseï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            gh release delete $TAG --yes 2>/dev/null || echo "ğŸ“Œ Release ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"

            # åˆ é™¤è¿œç¨‹æ ‡ç­¾
            git push --delete origin $TAG 2>/dev/null || echo "ğŸ“Œ è¿œç¨‹æ ‡ç­¾å·²åˆ é™¤"

            # åˆ é™¤æœ¬åœ°æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            git tag -d $TAG 2>/dev/null || true

            echo "âœ… æ—§ç‰ˆæœ¬å·²æ¸…ç†"
          else
            echo "âœ¨ æ ‡ç­¾ $TAG ä¸å­˜åœ¨ï¼Œç»§ç»­åˆ›å»ºæ–° Release"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ›å»º Release å¹¶ä¸Šä¼ äº§ç‰©
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.get-version.outputs.version }}
          name: v${{ needs.get-version.outputs.version }}
          body_path: changelog.md
          prerelease: ${{ needs.get-version.outputs.is_prerelease }}
          files: |
            dist/Smile2Unlock-win/*.exe
            # dist/Smile2Unlock-linux/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
