name: Release

on:
  push:
    branches:
      - main

# æƒé™é…ç½®ï¼šå…è®¸åˆ›å»º Release å’Œæ¨é€ Tag
permissions:
  contents: write  # å¿…éœ€ï¼šåˆ›å»º Releaseã€æ¨é€ Tag

# å¹¶å‘æ§åˆ¶ï¼šé˜²æ­¢å¤šæ¬¡ push åŒæ—¶æ‰§è¡Œå¯¼è‡´å†²çª
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false  # ä¸å–æ¶ˆæ—§æµç¨‹ï¼Œæ’é˜Ÿæ‰§è¡Œ

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_prerelease: ${{ steps.get_version.outputs.is_prerelease }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆ changelog

      - name: æå–ç‰ˆæœ¬å·
        id: get_version
        run: |
          # ä» README.md æå–ç‰ˆæœ¬å·ï¼ˆæ”¯æŒä»»æ„åç¼€ï¼ŒåŒ…æ‹¬ Shields.io çš„ -- è½¬ä¹‰ï¼‰
          # åŒ¹é…æ ¼å¼: version-X.Y.Z-é¢œè‰² æˆ– version-X.Y.Z--åç¼€-é¢œè‰²
          # æ³¨æ„ï¼šShields.io ä¸­ - éœ€è¦ç”¨ -- è½¬ä¹‰ï¼Œæ‰€ä»¥ 2.0.3-beta åœ¨ badge ä¸­æ˜¯ 2.0.3--beta
          full_version=$(sed -n 's/.*badge\/version-\([0-9]\+\.[0-9]\+\.[0-9]\+\(--\?[a-zA-Z0-9]\+\)\?\)-.*/\1/p' README.md | head -n1)

          if [ -z "$full_version" ]; then
            echo "âŒ æ— æ³•æå–ç‰ˆæœ¬å·ï¼Œè¯·æ£€æŸ¥ README.md ä¸­çš„ç‰ˆæœ¬æ ¼å¼"
            echo "æœŸæœ›æ ¼å¼: badge/version-X.Y.Z-é¢œè‰² æˆ– badge/version-X.Y.Z--åç¼€-é¢œè‰²"
            exit 1
          fi

          echo "ğŸ“¦ åŸå§‹ç‰ˆæœ¬: $full_version"

          # å°† Shields.io çš„ -- è½¬ä¹‰è¿˜åŸä¸º -
          full_version=$(echo "$full_version" | sed 's/--/-/g')
          echo "ğŸ”„ è¿˜åŸè½¬ä¹‰: $full_version"

          # ç§»é™¤ -stable åç¼€ï¼ˆæ­£å¼ç‰ˆä¸éœ€è¦ stable æ ‡è¯†ï¼‰
          clean_version=$(echo "$full_version" | sed 's/-stable$//')

          echo "âœ… æ¸…ç†åç‰ˆæœ¬: $clean_version"
          echo "version=$clean_version" >> $GITHUB_OUTPUT

          # åˆ¤æ–­æ˜¯å¦ä¸ºæ­£å¼ç‰ˆæœ¬
          # æ­£å¼ç‰ˆï¼šçº¯æ•°å­— (X.Y.Z) æˆ– X.Y.Z-stableï¼ˆå·²å»é™¤ -stableï¼‰
          if [[ "$clean_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "âœ¨ æ­£å¼ç‰ˆæœ¬"
          else
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "ğŸ§ª é¢„å‘å¸ƒç‰ˆæœ¬ (${clean_version##*-})"
          fi

  build:
    needs: get-version
    uses: ./.github/workflows/build-smile2unlock.yml

  create-release:
    needs: [build, get-version]
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆ changelog

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: æ¸…ç†åŒç‰ˆæœ¬çš„é¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆæ­£å¼ç‰ˆå‘å¸ƒæ—¶ï¼‰
        run: |
          VERSION=${{ needs.get-version.outputs.version }}
          BASE_VERSION=$(echo "$VERSION" | sed 's/-.*$//')
          IS_PRERELEASE=${{ needs.get-version.outputs.is_prerelease }}

          echo "ğŸ“¦ å½“å‰ç‰ˆæœ¬: $VERSION (åŸºç¡€ç‰ˆæœ¬: $BASE_VERSION)"
          echo "ï¿½ æ˜¯å¦ä¸ºé¢„å‘å¸ƒ: $IS_PRERELEASE"

          # å¦‚æœå½“å‰æ˜¯æ­£å¼ç‰ˆï¼Œåˆ é™¤æ‰€æœ‰åŒç‰ˆæœ¬çš„é¢„å‘å¸ƒç‰ˆæœ¬
          if [ "$IS_PRERELEASE" = "false" ]; then
            echo "ğŸ” æ£€æŸ¥åŒç‰ˆæœ¬çš„é¢„å‘å¸ƒç‰ˆæœ¬..."
            
            # æŸ¥æ‰¾åŒç‰ˆæœ¬çš„é¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆå¦‚ v1.0.3-beta, v1.0.3-alpha ç­‰ï¼‰
            SAME_VERSION_PRERELEASES=$(gh release list --limit 100 | grep "Pre-release" | awk '{print $1}' | grep "^v$BASE_VERSION-")
            
            if [ -n "$SAME_VERSION_PRERELEASES" ]; then
              echo "ï¿½ï¸  å‘ç°åŒç‰ˆæœ¬é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå‡†å¤‡åˆ é™¤:"
              echo "$SAME_VERSION_PRERELEASES"
              
              # é€ä¸ªåˆ é™¤
              echo "$SAME_VERSION_PRERELEASES" | while read -r PRERELEASE_TAG; do
                echo "ğŸ—‘ï¸  åˆ é™¤ $PRERELEASE_TAG..."
                gh release delete "$PRERELEASE_TAG" --yes 2>/dev/null || echo "âš ï¸  Release åˆ é™¤å¤±è´¥"
                git push --delete origin "$PRERELEASE_TAG" 2>/dev/null || echo "âš ï¸  Tag åˆ é™¤å¤±è´¥"
                git tag -d "$PRERELEASE_TAG" 2>/dev/null || true
              done
              
              echo "âœ… åŒç‰ˆæœ¬é¢„å‘å¸ƒç‰ˆæœ¬å·²æ¸…ç†"
            else
              echo "â„¹ï¸  æœªæ‰¾åˆ°åŒç‰ˆæœ¬é¢„å‘å¸ƒç‰ˆæœ¬"
            fi
          else
            echo "â„¹ï¸  å½“å‰ç‰ˆæœ¬ä¸ºé¢„å‘å¸ƒç‰ˆï¼Œè·³è¿‡æ¸…ç†"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è‡ªåŠ¨è½¬æ­£å¼ç‰ˆï¼ˆå½“ç‰ˆæœ¬å·å‰ç¼€å˜å¤§æ—¶ï¼‰
        id: promote_previous
        run: |
          VERSION=${{ needs.get-version.outputs.version }}
          BASE_VERSION=$(echo "$VERSION" | sed 's/-.*$//')
          IS_PRERELEASE=${{ needs.get-version.outputs.is_prerelease }}

          echo "ğŸ“¦ å½“å‰ç‰ˆæœ¬: $VERSION (åŸºç¡€ç‰ˆæœ¬: $BASE_VERSION)"
          echo "ğŸ“¦ æ˜¯å¦ä¸ºé¢„å‘å¸ƒ: $IS_PRERELEASE"

          # åªæœ‰å½“å‰ç‰ˆæœ¬æ˜¯é¢„å‘å¸ƒç‰ˆæ—¶ï¼Œæ‰æ£€æŸ¥æ˜¯å¦éœ€è¦è½¬æ­£ä¸Šä¸€ç‰ˆæœ¬
          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦è½¬æ­£ä¸Šä¸€ç‰ˆæœ¬..."
            
            # è·å–æœ€æ–°çš„é¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆæ’é™¤å½“å‰ç‰ˆæœ¬ï¼‰
            PREV_PRERELEASE=$(gh release list --limit 100 | grep 'Pre-release' | awk '{print $1}' | grep -v "^v$VERSION$" | head -n1)
            
            if [ -n "$PREV_PRERELEASE" ]; then
              echo "ğŸ“ æ‰¾åˆ°ä¸Šä¸€é¢„å‘å¸ƒç‰ˆæœ¬: $PREV_PRERELEASE"
              
              # æå–ä¸Šä¸€ç‰ˆæœ¬çš„åŸºç¡€ç‰ˆæœ¬å·
              PREV_BASE=$(echo "$PREV_PRERELEASE" | sed 's/^v//' | sed 's/-.*$//')
              
              echo "ğŸ“Š ç‰ˆæœ¬å¯¹æ¯”: $PREV_BASE vs $BASE_VERSION"
              
              # æ¯”è¾ƒç‰ˆæœ¬å·ï¼ˆä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ¯”è¾ƒ + sort -Vï¼‰
              LARGER=$(printf "%s\n%s\n" "$PREV_BASE" "$BASE_VERSION" | sort -V | tail -n1)
              
              if [ "$LARGER" = "$BASE_VERSION" ] && [ "$PREV_BASE" != "$BASE_VERSION" ]; then
                echo "ğŸ‰ æ£€æµ‹åˆ°ç‰ˆæœ¬å·å‰ç¼€å˜å¤§: $PREV_BASE â†’ $BASE_VERSION"
                echo "ğŸ”„ å¼€å§‹è½¬æ­£ $PREV_PRERELEASE ä¸ºæ­£å¼ç‰ˆ..."
                
                # 1. åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾æ—§äº§ç‰©
                mkdir -p old-artifacts
                
                # 2. ä¸‹è½½æ—§ç‰ˆæœ¬äº§ç‰©ï¼ˆå¤±è´¥åˆ™è·³è¿‡è½¬æ­£ï¼‰
                echo "ğŸ“¥ ä¸‹è½½æ—§ç‰ˆæœ¬äº§ç‰©..."
                if gh release download "$PREV_PRERELEASE" --dir old-artifacts/ 2>/dev/null; then
                  echo "âœ… äº§ç‰©ä¸‹è½½æˆåŠŸ"
                  
                  # 3. è·å–æ—§ç‰ˆæœ¬æŒ‡å‘çš„ commit
                  echo "ğŸ” è·å–æ—§ç‰ˆæœ¬ commit..."
                  PREV_COMMIT=$(git rev-list -n 1 "$PREV_PRERELEASE" 2>/dev/null || echo "")
                  
                  if [ -z "$PREV_COMMIT" ]; then
                    echo "âš ï¸  æ— æ³•è·å–æ—§ç‰ˆæœ¬ commitï¼Œä½¿ç”¨å½“å‰ HEAD"
                    PREV_COMMIT="HEAD~1"
                  fi
                  
                  # 4. åˆ é™¤æ—§ç‰ˆæœ¬ release å’Œ tag
                  echo "ğŸ—‘ï¸  åˆ é™¤æ—§ç‰ˆæœ¬ release å’Œ tag..."
                  gh release delete "$PREV_PRERELEASE" --yes 2>/dev/null || echo "âš ï¸  Release åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨"
                  git push --delete origin "$PREV_PRERELEASE" 2>/dev/null || echo "âš ï¸  Tag åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨"
                  git tag -d "$PREV_PRERELEASE" 2>/dev/null || true
                  
                  # 5. åˆ›å»ºæ–°çš„æ­£å¼ç‰ˆ tag
                  NEW_STABLE_TAG="v$PREV_BASE"
                  echo "ğŸ·ï¸  åˆ›å»ºæ–°æ­£å¼ç‰ˆ tag: $NEW_STABLE_TAG"
                  git tag "$NEW_STABLE_TAG" "$PREV_COMMIT"
                  git push origin "$NEW_STABLE_TAG"
                  
                  # 6. åˆ›å»ºæ–°çš„æ­£å¼ç‰ˆ releaseï¼ˆä½¿ç”¨ GitHub è‡ªåŠ¨ç”Ÿæˆ changelogï¼‰
                  echo "ğŸŠ åˆ›å»ºæ­£å¼ç‰ˆ release: $NEW_STABLE_TAG"
                  gh release create "$NEW_STABLE_TAG" \
                    --title "v$PREV_BASE" \
                    --notes "æœ¬ç‰ˆæœ¬ç”± \`$PREV_PRERELEASE\` è‡ªåŠ¨è½¬ä¸ºæ­£å¼ç‰ˆã€‚" \
                    --generate-notes \
                    old-artifacts/*
                  
                  echo "âœ… æˆåŠŸå°† $PREV_PRERELEASE è½¬ä¸ºæ­£å¼ç‰ˆ $NEW_STABLE_TAG"
                  echo "promoted=true" >> $GITHUB_OUTPUT
                  echo "promoted_tag=$NEW_STABLE_TAG" >> $GITHUB_OUTPUT
                else
                  echo "âš ï¸  æ— æ³•ä¸‹è½½æ—§ç‰ˆæœ¬äº§ç‰©ï¼Œè·³è¿‡è½¬æ­£"
                  echo "promoted=false" >> $GITHUB_OUTPUT
                fi
              else
                echo "â„¹ï¸  ç‰ˆæœ¬å·æœªå˜å¤§æˆ–ç›¸åŒç‰ˆæœ¬ï¼Œæ— éœ€è½¬æ­£"
                echo "promoted=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "â„¹ï¸  æœªæ‰¾åˆ°ä¸Šä¸€é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œæ— éœ€è½¬æ­£"
              echo "promoted=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸  å½“å‰ç‰ˆæœ¬ä¸ºæ­£å¼ç‰ˆï¼Œè·³è¿‡è½¬æ­£é€»è¾‘"
            echo "promoted=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥å¹¶åˆ é™¤å·²å­˜åœ¨çš„ Release å’Œæ ‡ç­¾
        run: |
          VERSION=${{ needs.get-version.outputs.version }}
          TAG="v$VERSION"

          echo "ğŸ” æ£€æŸ¥æ ‡ç­¾ $TAG æ˜¯å¦å­˜åœ¨"

          # æ£€æŸ¥è¿œç¨‹æ ‡ç­¾æ˜¯å¦å­˜åœ¨
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "âš ï¸  æ ‡ç­¾ $TAG å·²å­˜åœ¨ï¼Œå‡†å¤‡åˆ é™¤"

            # åˆ é™¤è¿œç¨‹ Releaseï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            gh release delete $TAG --yes 2>/dev/null || echo "ğŸ“Œ Release ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"

            # åˆ é™¤è¿œç¨‹æ ‡ç­¾
            git push --delete origin $TAG 2>/dev/null || echo "ğŸ“Œ è¿œç¨‹æ ‡ç­¾å·²åˆ é™¤"

            # åˆ é™¤æœ¬åœ°æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            git tag -d $TAG 2>/dev/null || true

            echo "âœ… æ—§ç‰ˆæœ¬å·²æ¸…ç†"
          else
            echo "âœ¨ æ ‡ç­¾ $TAG ä¸å­˜åœ¨ï¼Œç»§ç»­åˆ›å»ºæ–° Release"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ›å»º Release å¹¶ä¸Šä¼ äº§ç‰©
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.get-version.outputs.version }}
          name: v${{ needs.get-version.outputs.version }}
          prerelease: ${{ needs.get-version.outputs.is_prerelease }}
          generate_release_notes: true  # ä½¿ç”¨ GitHub è‡ªåŠ¨ç”Ÿæˆ Changelog
          files: |
            dist/Smile2Unlock-win/Smile2Unlock.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
